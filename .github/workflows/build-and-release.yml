name: ğŸ—ï¸ Build and Release ChronoGuard

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: false
        default: '1.0.0'
      create_release:
        description: 'Create GitHub Release'
        type: boolean
        default: false

env:
  DOTNET_VERSION: '8.0.x'
  SOLUTION_PATH: 'ChronoGuard/ChronoGuard.sln'
  APP_PROJECT: 'ChronoGuard/src/ChronoGuard.App/ChronoGuard.App.csproj'
  CONFIGURATION: 'Release'
  PLATFORM: 'x64'

jobs:
  # ============================================================================
  # BUILD JOB - Build and test the application
  # ============================================================================
  build:
    name: ğŸ”¨ Build & Test
    runs-on: windows-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      should_release: ${{ steps.version.outputs.should_release }}
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Full history for GitVersion
    
    - name: ğŸ› ï¸ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: ğŸ“‹ Display .NET Info
      run: dotnet --info
    
    - name: ğŸ”¢ Determine Version
      id: version
      run: |
        if ("${{ github.event_name }}" -eq "workflow_dispatch" -and "${{ github.event.inputs.version }}" -ne "") {
          $version = "${{ github.event.inputs.version }}"
          $shouldRelease = "${{ github.event.inputs.create_release }}"
        } elseif ("${{ github.ref }}" -like "refs/tags/v*") {
          $version = "${{ github.ref }}".Replace("refs/tags/v", "")
          $shouldRelease = "true"
        } else {
          $version = "1.0.0-dev.${{ github.run_number }}"
          $shouldRelease = "false"
        }
        
        echo "version=$version" >> $env:GITHUB_OUTPUT
        echo "should_release=$shouldRelease" >> $env:GITHUB_OUTPUT
        echo "ğŸ”¢ Version: $version"
        echo "ğŸš€ Should Release: $shouldRelease"
    
    - name: ğŸ“¦ Restore Dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}
    
    - name: ğŸ—ï¸ Build Solution
      run: |
        dotnet build ${{ env.SOLUTION_PATH }} `
          --configuration ${{ env.CONFIGURATION }} `
          --no-restore `
          --verbosity minimal `
          -p:Version=${{ steps.version.outputs.version }}
    
    - name: ğŸ§ª Run Tests
      run: |
        dotnet test ${{ env.SOLUTION_PATH }} `
          --configuration ${{ env.CONFIGURATION }} `
          --no-build `
          --verbosity minimal `
          --logger "trx;LogFileName=test-results.trx" `
          --collect:"XPlat Code Coverage"
    
    - name: ğŸ“Š Publish Test Results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: 'Test Results'
        path: '**/test-results.trx'
        reporter: 'dotnet-trx'
    
    - name: ğŸ“„ Upload Test Coverage
      uses: codecov/codecov-action@v3
      if: always()
      with:
        directory: ./coverage
        flags: unittests
        name: codecov-umbrella
    
    - name: ğŸ—ï¸ Publish Application
      run: |
        dotnet publish ${{ env.APP_PROJECT }} `
          --configuration ${{ env.CONFIGURATION }} `
          --runtime win-${{ env.PLATFORM }} `
          --self-contained true `
          --output "./publish" `
          -p:PublishSingleFile=false `
          -p:PublishTrimmed=false `
          -p:Version=${{ steps.version.outputs.version }}
    
    - name: ğŸ“¤ Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: chronoguard-build-${{ steps.version.outputs.version }}
        path: ./publish/
        retention-days: 30

  # ============================================================================
  # PACKAGE JOB - Create distribution packages
  # ============================================================================
  package:
    name: ğŸ“¦ Create Packages
    runs-on: windows-latest
    needs: build
    if: github.event_name != 'pull_request'
    
    strategy:
      matrix:
        package-type: ['portable', 'msi', 'msix']
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ğŸ› ï¸ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: ğŸ“¥ Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: chronoguard-build-${{ needs.build.outputs.version }}
        path: ./ChronoGuard/src/ChronoGuard.App/bin/Release/net8.0-windows10.0.22621.0/publish/
    
    - name: ğŸ› ï¸ Setup WiX Toolset (MSI)
      if: matrix.package-type == 'msi'
      run: |
        # Download and install WiX Toolset
        Invoke-WebRequest -Uri "https://github.com/wixtoolset/wix3/releases/download/wix3112rtm/wix311.exe" -OutFile "wix311.exe"
        Start-Process -FilePath "wix311.exe" -ArgumentList "/quiet" -Wait
        
        # Add to PATH
        $env:PATH += ";C:\Program Files (x86)\WiX Toolset v3.11\bin"
        echo "C:\Program Files (x86)\WiX Toolset v3.11\bin" >> $env:GITHUB_PATH
    
    - name: ğŸ› ï¸ Setup Windows SDK (MSIX)
      if: matrix.package-type == 'msix'
      uses: microsoft/setup-msbuild@v1
    
    - name: ğŸ“¦ Build Portable Package
      if: matrix.package-type == 'portable'
      run: |
        .\ChronoGuard\packaging\build-portable.ps1 `
          -Configuration ${{ env.CONFIGURATION }} `
          -Version ${{ needs.build.outputs.version }} `
          -Platform ${{ env.PLATFORM }}
    
    - name: ğŸ“¦ Build MSI Package
      if: matrix.package-type == 'msi'
      run: |
        .\ChronoGuard\packaging\build-msi.ps1 `
          -Configuration ${{ env.CONFIGURATION }} `
          -Version ${{ needs.build.outputs.version }} `
          -Platform ${{ env.PLATFORM }}
    
    - name: ğŸ“¦ Build MSIX Package
      if: matrix.package-type == 'msix'
      run: |
        .\ChronoGuard\packaging\build-msix.ps1 `
          -Configuration ${{ env.CONFIGURATION }} `
          -Version ${{ needs.build.outputs.version }} `
          -Platform ${{ env.PLATFORM }}
    
    - name: ğŸ“¤ Upload Package Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: chronoguard-${{ matrix.package-type }}-${{ needs.build.outputs.version }}
        path: ./ChronoGuard/packaging/output/
        retention-days: 30

  # ============================================================================
  # RELEASE JOB - Create GitHub release with packages
  # ============================================================================
  release:
    name: ğŸš€ Create Release
    runs-on: windows-latest
    needs: [build, package]
    if: needs.build.outputs.should_release == 'true'
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ğŸ“¥ Download All Packages
      uses: actions/download-artifact@v4
      with:
        pattern: chronoguard-*-${{ needs.build.outputs.version }}
        path: ./release-assets/
        merge-multiple: true
    
    - name: ğŸ“‹ List Release Assets
      run: |
        echo "ğŸ“ Release Assets:"
        Get-ChildItem -Path "./release-assets" -Recurse -File | ForEach-Object {
          $size = [math]::Round($_.Length / 1MB, 2)
          echo "   ğŸ“„ $($_.Name) ($size MB)"
        }
    
    - name: ğŸ“ Generate Release Notes
      id: release_notes
      run: |
        $version = "${{ needs.build.outputs.version }}"
        $date = Get-Date -Format "yyyy-MM-dd"
        
        $releaseNotes = @"
        # ğŸŒ… ChronoGuard v$version
        
        **Release Date:** $date
        
        ## ğŸ“¦ Download Options
        
        Choose the installation method that works best for you:
        
        ### ğŸ”§ MSI Installer (Recommended)
        - **File:** ``ChronoGuard-Setup-v$version.msi``
        - **Best for:** Most Windows users
        - **Features:** Automatic updates, Windows integration, easy uninstall
        
        ### ğŸ“± MSIX Package (Modern Windows)
        - **File:** ``ChronoGuard-v$version.msix``
        - **Best for:** Windows 10/11 users, Microsoft Store-like experience
        - **Features:** Sandboxed installation, automatic updates
        
        ### ğŸ“¦ Portable Version
        - **File:** ``ChronoGuard-Portable-v$version.zip``
        - **Best for:** No installation needed, USB drives, testing
        - **Features:** Self-contained, leave no traces
        
        ## ğŸ†• What's New in v$version
        
        - âœ¨ Advanced color temperature management
        - ğŸ–¥ï¸ Multi-monitor support
        - ğŸŒ… Automatic sunrise/sunset detection
        - ğŸ¨ Custom color profiles
        - âš™ï¸ System tray integration
        - ğŸ”„ Automatic updates
        - ğŸŒ Location-based adjustments
        
        ## ğŸ’» System Requirements
        
        - **OS:** Windows 10 version 1903+ or Windows 11
        - **Runtime:** .NET 8.0 (included in installers)
        - **Graphics:** DirectX 11 compatible graphics card
        - **RAM:** 50 MB
        - **Storage:** 100 MB
        
        ## ğŸš€ Quick Start
        
        1. Download and install using your preferred method above
        2. ChronoGuard will start automatically and appear in system tray
        3. Right-click the tray icon to access settings
        4. Enjoy automatic color temperature adjustments!
        
        ## ğŸ“š Documentation
        
        - [Installation Guide](https://github.com/your-username/ChronoGuard/blob/main/docs/guides/INSTALLATION.md)
        - [User Manual](https://github.com/your-username/ChronoGuard/wiki)
        - [FAQ](https://github.com/your-username/ChronoGuard/wiki/FAQ)
        
        ## ğŸ› Known Issues
        
        - Some graphics drivers may require updates for optimal compatibility
        - Windows 10 versions before 1903 are not supported
        
        ## ğŸ¤ Support
        
        - **Issues:** [GitHub Issues](https://github.com/your-username/ChronoGuard/issues)
        - **Discussions:** [GitHub Discussions](https://github.com/your-username/ChronoGuard/discussions)
        - **Email:** support@chronoguard.dev
        
        ## âœ¨ Special Thanks
        
        Thanks to all contributors and beta testers who made this release possible!
        
        ---
        
        **Full Changelog:** [v$version...main](https://github.com/your-username/ChronoGuard/compare/v$version...main)
        "@
        
        # Save to file for upload
        $releaseNotes | Out-File -FilePath "release-notes.md" -Encoding utf8
        
        # Output for GitHub (escape newlines)
        $escaped = $releaseNotes -replace "`r`n", "%0A" -replace "`n", "%0A"
        echo "notes=$escaped" >> $env:GITHUB_OUTPUT
    
    - name: ğŸ·ï¸ Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ needs.build.outputs.version }}
        name: ChronoGuard v${{ needs.build.outputs.version }}
        body_path: release-notes.md
        files: |
          ./release-assets/**/*
        draft: false
        prerelease: ${{ contains(needs.build.outputs.version, '-') }}
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ‰ Release Success
      run: |
        echo "ğŸ‰ Release created successfully!"
        echo "ğŸ”— URL: https://github.com/${{ github.repository }}/releases/tag/v${{ needs.build.outputs.version }}"
        echo "ğŸ“¦ Packages: MSI, MSIX, Portable"
        echo "ğŸš€ ChronoGuard v${{ needs.build.outputs.version }} is now live!"

  # ============================================================================
  # CLEANUP JOB - Clean up artifacts
  # ============================================================================
  cleanup:
    name: ğŸ§¹ Cleanup
    runs-on: windows-latest
    needs: [build, package]
    if: always() && github.event_name != 'workflow_dispatch'
    
    steps:
    - name: ğŸ—‘ï¸ Delete Build Artifacts
      uses: geekyeggo/delete-artifact@v2
      with:
        name: |
          chronoguard-build-${{ needs.build.outputs.version }}
        failOnError: false
